apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "open-ondemand.fullname" . }}-hostbased-auth
data:
  hostbased.sh: |
    #!/bin/bash
  {{ if eq .Values.enableHostAdapter true }}
  {{ if eq .Values.advanced.NFS true }}
    for i in `ls {{ .Values.advanced.fileSharing.nfs_path }}`; do
      ln -s {{ .Values.advanced.fileSharing.nfs_path }}/$i /home/$i
    done
  {{ end }}
  {{ end }}
  {{ if eq .Values.generateUsers true }}
    while [ ! -f /shared/newusers.txt ]; do
      sleep 2
    done
    newusers /shared/newusers.txt
  {{ end }}
    mkdir -p {{ .Values.advanced.fileSharing.nfs_path }}
    array=()
    groupmod -g {{ .Values.advanced.ssh_keys_GID }} ssh_keys
    for i in `ls /root | grep .pub`; do
      array+=("$i")
    done
    for i in ${array[@]}; do
      cat /root/$i > /etc/ssh/$i && chmod 0644 /etc/ssh/$i
    done
    array=()
    for i in `ls /root/*_key | sed 's/\/root\///g'`; do
      array+=("$i")
    done
    for i in ${array[@]}; do
      cat /root/$i > /etc/ssh/$i && chmod 0640 /etc/ssh/$i && chgrp ssh_keys /etc/ssh/$i
    done
    chgrp ssh_keys /usr/libexec/openssh/ssh-keysign
    chmod g+s /usr/libexec/openssh/ssh-keysign
    groupadd slate
    groupmod -g 400835 slate
    cat >> /root/test_users.txt <<EOF
    slatetest01::67362::4000835::/uufs/chpc.utah.edu/common/home/slatetest01
    slatetest01::67363::4000835::/uufs/chpc.utah.edu/common/home/slatetest02
    slatetest01::67364::4000835::/uufs/chpc.utah.edu/common/home/slatetest03
    EOF
    newusers /root/test_users.txt
    supervisorctl restart autofs